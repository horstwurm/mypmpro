<%= header(@mobject.mtype + " " + @mobject.name) %>
<%= navigate2("objekte", @mobject, @topic) %>

<div id="main">
  
  <div class="row">
      <div class='col-xs-12'>
      <% case @topic %>
        <% when "objekte_info" %>

          <div class="panel-body">
              <!--ACHTUNG ARTIKEL SPEZIAL            -->
              <% if @mobject.mtype == "artikel" %>
                <%= build_article(@mobject) %> 
              <% end %>
              <% if @mobject.mtype != "artikel" %>
               <% case @mobject.status %>
                  <% when "CHECK" %>
                    <i class="fa fa-question-sign"></i>
                  <% when "OK" %>
                    <i class="fa fa-ok-circle"></i>
                  <% when "NOK" %>
                    <i class="fa fa-ban-circle"></i>
                <% end %>
                <b> <%= I18n.t :status %></b>
                <br>
                <%= carousel2(@mobject, :medium) %>
                <br><br>
              <% end %>

                <% case @mobject.msubtype %>
                  <% when "spenden" %>
                    <b><%= I18n.t :spendenziel %></b><br>
                    <%= sprintf("%05.2f CHF", @mobject.amount) %>
                    <br>
                  <% when "belohnungen" %>
                    <b><%= I18n.t :projektziel %></b><br>
                    <%= sprintf("%05.2f CHF", @mobject.amount) %>
                    <br><br>
                    <b><%= I18n.t :stueckelung %></b><br>
                    <%= sprintf("%05.2f CHF", @mobject.price) %>
                    <br><br>
                    <b><%= I18n.t :belohnung %></b><br>
                    <%= @mobject.reward %>
                    <br>
                  <% when "zinsen" %>
                    <b><%= I18n.t :kreditsumme %></b><br>
                    <%= sprintf("%05.2f CHF", @mobject.amount) %>
                    <br><br>
                    <b><%= I18n.t :zinssatz %></b><br>
                    <%= @mobject.interest_rate %>%
                    <br><br>
                    <%= I18n.t :rueckzahlung %> <%= @mobject.due_date.strftime("%d.%m.%Y") %>
                    <br>
                <% end %>
                <br>
                <% if @mobject.mtype == "crowdfunding" %>
                
                  <% if @mobject.mtype == "Crowdfunding" and @mobject.sum_amount and @mobject.sum_amount >= @mobject.amount %>
                    <%= render("mobjects/form_crowdfunding_service") %>
                  <% end %>
                
                  <% soll = @mobject.amount %>
                  <% if @mobject.mtype == "crowdfunding" %>
                    <% if @mobject.mstats != nil %>
                      <% ist  = @mobject.mstats.sum(:amount) %>
                    <% else %>
                      <% ist = 0 %>
                    <% end %>
                    <b>Betrag</b><br>
                  <% end %>
                  <% if !ist %>
                    <% ist = 0 %>
                  <% end %>
                  <% if !soll %>
                    <% soll = 0 %>
                  <% end %>
                  <%= sprintf("%05.2f CHF", ist) %>
                  <br><br>
                  <div class="progress">
                    <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="<%= ist %>" aria-valuemin="0" aria-valuemax="<%= soll %>" style="width:<%= (ist/soll*100) %>%">
                      <span class="sr-only">40% Complete (success)</span>
                    </div>
                  </div>
      
        				  <% if @mobject.price %>
                    <preiss><b><%= sprintf("%05.2f"+(I18n.t :waehrung), @mobject.price) %></b></preiss>
        					<% else %>
                    <% if @mobject.social %>
                      <preiss><b><i class='fa fa-heart'></i></b></preiss>
                    <% end %>
        					<% end %>
                  <br><br>
                <% end %>
                
                <% case @mobject.mtype %>
                   <% when "angebote", "veranstaltungen", "ausschreibungen", "crowdfunding", "umfragen", "projekte", "innovationswettbewerbe" %>

                    <% if @mobject.mtype == "umfragen" %>
                    
                      <% useranswers = [] %>
                      <% @mobject.questions.each do |q| %>
                        <% q.answers.each do |a| %>
                          <% a.user_answers.each do |u| %>
                            <% if !useranswers.include?(u.user_id) %>
                              <% useranswers << u.user_id %>
                            <% end %>
                          <% end %>
                        <% end %>
                      <% end %>
                      
                      <%= header("Anzahl Teilnehmer "+ "<span class='badge'>" + useranswers.count.to_s + "</span>") %>

                      <div class="row">
                        
                        <% if false %>
                        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-6">
                          <div>
                            <%= header("Antworten pro Frage") %>
                          </div>
                          <div id="chartq"></div>
                        </div>
                        <% end %>
                        <br>
 
                         <% @mobject.questions.each do |q| %>
                          <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-6">
                            <div>
                              <%= header(q.name) %>
                            </div>
                            <div id="<%="chart"+q.id.to_s %>"></div>
                          </div>
                        <% end %>
                      </div>
                      <br>
                    <% end %>
                    
                     <% if @mobject.msubtype == "standard" %>
                     <% else %>
                      <% if @mobject.msubtype == "aktion" %>
                        <b><%= I18n.t :price %></b><br>
                        <% if @mobject.price_new %> 
                          <%= sprintf("%05.2f"+(I18n.t :waehrung),@mobject.price_new) %> / 
                        <% end %>
                        <% if @mobject.price_reg  %>
                          <%= sprintf("%05.2f"+(I18n.t :waehrung),@mobject.price_reg) %><br>
                        <% end %>
                        <br>
                      <% end %>
                      <b><%= (I18n.t :datumvonbis) %></b><br>
                      <% if @mobject.date_from  %>
                        <%= @mobject.date_from.strftime("%d.%m.%Y") %>
                      <% end %>
                      <% if @mobject.date_to %>
                      - <%= @mobject.date_to.strftime("%d.%m.%Y") %>
                      <% end %>
                      <% if @mobject.date_from or @mobject.date_to %>
                        <br><br>
                      <% end %>
                      <% if @mobject.date_to != nil %>
                        <b><%= (I18n.t :laufzeit) %></b><br>
                        <b><ntext><%= (I18n.t :noch) %> </ntext></b><restlaufzeits><%= (@mobject.date_to.to_date - DateTime.now.to_date).to_i.to_s %></restlaufzeits> <b><ntext> <%= (I18n.t :tage) %></ntext></b>
                        <br>
                        <% soll = (@mobject.date_to.to_date - @mobject.date_from.to_date).to_i %>
                        <% ist = (DateTime.now.to_date - @mobject.date_from.to_date).to_i %>
                        <% if soll > 0 and ist > 0 %>
                        <div class="progress">
                          <div class="progress-bar progress-bar-warning progress-bar-striped" role="progressbar2" aria-valuenow="<%= ist %>" aria-valuemin="0" aria-valuemax="<%= soll %>" style="width:<%= (ist*100/soll) %>%">
                            <span class="sr-only">40% Complete (success)</span>
                          </div>
                        </div>
                        <% end %>
                      <% end %>
                      <br>
                      <% if @mobject.mtype == "veranstaltungen" and @mobject.eventpart %>
                          </b><i class="fa fa-info"></i> Anmeldung obligatorisch</b>
                       <% end %>
                      <% end %>
    
                   <% when "vermietungen" %>
                    <% if false %>
                    <b><%= (I18n.t :mietzeiten) %></b><br>
                    von:<%= @mobject.time_from %> bis: <%= @mobject.time_to %> Uhr
                    <br><br>
                    <% end %>
                    <b><%= (I18n.t :standort) %></b><br>
                    <%= @mobject.address1 if @mobject.address1 %><br>
                    <%= @mobject.address2 if @mobject.address2 %><br>
                    <%= @mobject.address3 if @mobject.address3 %><br>
                    <br>
                    
                   <% when "projekte" %>
                    <%= header(:projekte) %>
                    <div class="panel-body">
                      <%= build_medialistNew(Mobject.where('parent=?',@mobject.id).order(created_at: :desc), "mobjects", "user") %>
                    </div>
                    <br>

                   <% when "sponsorantraege" %>

                    <b><%= I18n.t :periodizitaet %></b><br>
                    <%= @mobject.sponsorenperiode %><br>
                    <b><%= I18n.t :status %></b><br>
                    <%= @mobject.sponsorenstatus %><br>
                    <b><%= I18n.t :beantragterbetrag %></b><br>
                    <%= sprintf("%05.2f CHF",@mobject.sponsorenbetragantrag) %><br><br>
                    
                    <% found = false %>
                    <% @mobject.madvisors.each do |u| %>
                      <% if u.user_id == current_user.id %>
                        <% found = true %>
                      <% end %>
                    <% end %>

                    <% if found or current_user.superuser %>
                      <%= header(I18n.t :bewertungen) %>
                      <br>
                      <table class="table table-striped">
                        <tr>
                          <td></td>
                          <td>Bewerter</td>
                          <td>Bewertung</td>
                          <td>Empfehlung</td>
                          <td>Betrag</td>
                        </tr>
                        <% @mobject.madvisors.each do |a| %>
                          <tr>
                            <td>
                              <% if a.user_id == current_user.id %>
                                <% @sponsor_rating = SponsorRating.where('mobject_id=? and user_id=?',@mobject.id, a.user_id).first %>
                                <% if !@sponsor_rating %>
                                  <% @sponsor_rating = SponsorRating.new %>
                                  <% @sponsor_rating.user_id = a.user_id %>
                                  <% @sponsor_rating.mobject_id = @mobject.id %>
                                  <% @sponsor_rating.descriptions = "" %>
                                  <% @sponsor_rating.decision = false %>
                                  <% @sponsor_rating.save %>
                                <% end %>
    	                          <%= link_to(edit_sponsor_rating_path(@sponsor_rating, :mobject_id => @mobject.id)) do %>
                                  <i class="btn btn-primary btn-lg fa fa-star"></i>
                                <% end %>
                              <% end %>
                            </td>
                            <td><%= a.user.email %></td>
                            <% @ur = a.user.sponsor_ratings.where('mobject_id=?', a.mobject_id).first %>
                            <% if @ur and @ur.descriptions != "" %>
                              <td><%= @ur.descriptions %></td>
                              <% if @ur.decision %>
                                <td><%= I18n.t :empfohlen %></td>
                              <% else %>
                                <td><%= I18n.t :nichtempfohlen %></td>
                              <% end %>
                              <td><%= @ur.amount.to_s %></td>
                            <% else %>
                              <td><%= I18n.t :notrated %></td><td></td><td></td>
                            <% end %>
                          </tr>
                        <% end %>
                      </table>
                      <b><%= I18n.t :genehmigterbetrag %></b><br>
                      <%= sprintf("%05.2f CHF",@mobject.sponsorenbetraggenehmigt) if @mobject.sponsorenbetraggenehmigt != nil %><br>
                      <b><%= I18n.t :antwort %></b><br>
                      <%= @mobject.sponsorenantwort %>
                    <% end %>

                 <% when "stellenanzeigen" %>
                      <div class="row">
                        <div class="col-sm-6 col-md-4 col-lg-3">
                          <div class="thumbnail" align="center">
                            <anzeigetext>
                            <% if @mobject.msubtype == "anbieten" %>
                  						<%= (I18n.t :aufgaben) %>
                  					<% else %>
                  					  <%= (I18n.t :referenzen) %>
                  					<% end %>
                            </anzeigetext>
                            <p>
                              <ntext>
                  						<%= @mobject.tasks %>
                  						</ntext>
                  					</p>
                          </div>
                        </div>
                        
                        <div class="col-sm-6 col-md-4 col-lg-3">
                          <div class="thumbnail" align="center">
                            <anzeigetext>
                              <%= (I18n.t :qualifikationen) %>
                            </anzeigetext>
                            <p>
                              <ntext>
                  						<%= @mobject.skills %>
                  						</ntext>
                  					</p>
                          </div>
                        </div>
                
                        <div class="col-sm-6 col-md-4 col-lg-3">
                          <div class="thumbnail" align="center">
                            <anzeigetext>
                              <%= (I18n.t :jobangebot) %>
                            </anzeigetext>
                            <p>
                              <ntext>
                  						<%= @mobject.offers %>
                  						</ntext>
                  					</p>
                          </div>
                        </div>
                    </div>
                <% end %>
                
                <% if @mobject.mtype == "projekte" %>
                  <% ist = @mobject.sum_pkosten_ist %>
                  <% soll = @mobject.sum_pkosten_plan %>
                  <% if !ist %>
                    <% ist = 0 %>
                  <% end %>
                  <% if !soll %>
                    <% soll = 0 %>
                  <% end %>
                  <b><%= I18n.t :kosten %></b><br>
                  <b><ntext><%= I18n.t :noch %> </ntext></b><restlaufzeits><%= soll - ist %></restlaufzeits> <b><ntext> <%= I18n.t :waehrung %></ntext></b>
                  <br>
                  <% if soll > 0 %>
                    <div class="progress">
                      <div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="<%= ist %>" aria-valuemin="0" aria-valuemax="<%= soll %>" style="width:<%= (ist/soll*100) %>%">
                        <span class="sr-only">40% Complete (success)</span>
                      </div>
                    </div>
                  <% end %>

                  <% ist = @mobject.sum_paufwand_ist.to_i %>
                  <% soll = @mobject.sum_paufwand_plan %>
                  <% if !ist %>
                    <% ist = 0 %>
                  <% end %>
                  <% if !soll %>
                    <% soll = 0 %>
                  <% end %>
                  <b><%= I18n.t :aufwand %></b><br>
                  <b><ntext><%= I18n.t :noch %> </ntext></b><restlaufzeits><%= soll - ist %></restlaufzeits> <b><ntext> <%= I18n.t :personentage %></ntext></b>
                  <br>
                  <% if soll > 0 %>
                    <div class="progress">
                      <div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="<%= ist %>" aria-valuemin="0" aria-valuemax="<%= soll %>" style="width:<%= (ist/soll*100) %>%">
                        <span class="sr-only">40% Complete (success)</span>
                      </div>
                    </div>
                  <% end %>

                  <b><%= I18n.t :qualitaet %></b><br>
                  <div class="quality<%= @mobject.quality %>", style="font-size:4em">
                    <i class="fa fa-stop"></i>
                  </div>
                  <b><%= I18n.t :risiko %></b><br>
                  <div class="risk<%= @mobject.risk %>", style="font-size:4em">
                    <span><i class="fa fa-stop"></i></span>
                  </div>

                  <br>

                <% end %>
                
                <% if @mobject.mtype == "" %>
                  <b><%= I18n.t :bewertung %></b><br>
                  <% avg_rating2(@mobject.id).times do %>
                    <i class="fa fa-star"></i>
                  <% end %>
                  <br><br>
                <% end %>
                
                <% if @mobject.social %>
                    <i class="fa fa-heart"></i> soziales Engagement
                <% end %>
                <br><br>
    
                <% if @mobject.homepage != nil %>
                  <b><%= I18n.t :homepage %></b><br>
                  <%= link_to url_with_protocol(@mobject.homepage), :target => '_blank' do %>
                    <i class="fa fa-home"></i> <%= url_with_protocol(@mobject.homepage) %>
                  <% end %>
                  <br><br>
                <% end %>
                
                <% if @mobject.description %>
                  <b><%= I18n.t :beschreibung %></b><br>
            			<%= @mobject.description %>
                  <br><br>
                <% end %>
                <% if @mobject.mcategory_id %>
                  <b><%= I18n.t :kategorie %></b><br>
            			<%= @mobject.mcategory.name %>
                  <br><br>
                <% end %>

              <% if @mobject.mtype == "projekte" %>
                <%= header((I18n.t :projekte)) %>
                <div class="panel-body">
                  <%= build_medialistNew(Mobject.where('parent=?',@mobject.id).order(created_at: :desc), "mobjects", "user") %>
                </div>
                <br>
              <% end %>
            
              <% if @mobject.mtype == "gruppen" %>
                <%= header((I18n.t :gruppenmitglieder)) %>
                <div class="panel-body">
                  <%= build_medialistNew(@mobject.madvisors.where('role=?', @mobject.mtype), "madvisors", "user") %>
                </div>
                <br>
              <% end %>

               <% if @mobject.mtype == "innovationswettbewerbe" %>
                <%= header((I18n.t :ideen)) %>
                <div class="panel-body">
                  <%= build_medialistNew(@mobject.ideas.order(rating: :desc), "ideas", "user") %>
                </div>
                <br>
                <%= header((I18n.t :preise)) %>
                <div class="panel-body">
                  <%= build_medialistNew(@mobject.prices.order(:sequence), "prices", nil) %>
                </div>
                <br>
                <%= header((I18n.t :bewertungskriterien)) %>
                <div class="panel-body">
                  <%= build_medialistNew(@mobject.crits.order(:name), "crits", nil) %>
                </div>
                <br>
                <%= header((I18n.t :jury)) %>
                <div class="panel-body">
                  <%= build_medialistNew(@mobject.madvisors.where("role=? and (grade=? or grade=?)", "innovationswettbewerbe", "Jury-Vorsitz", "Jury-Mitglied"), "madvisors", "user") %>
                </div>
                <br>
               <% end %>

              <b><%= I18n.t :verantwortlich %></b><br>
              <%= contactChip(@mobject.owner) %>
        			<br><br>
              <%= @mobject.created_at.strftime("%d.%m.%Y") %>
              </div>
    
              <%= header((I18n.t :standort)) %>
              <div class="panel-body">
                <% if @mobject.longitude and @mobject.latitude %>
                  <i class="fa fa-map-marker pull-left" onclick="return init_map(0);"></i>
                  <div id="map">
                    <div id="map-canvas"></div>
                  </div>
                <% end %>
              </div>

        <% when "objekte_details" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.mdetails.order(:sequence), "mdetails", nil) %>
          </div>

        <% when "objekte_umfrageteilnehmer" %>
          <div class="panel-body">
            <% useranswers = [] %>
            <% @mobject.questions.each do |q| %>
              <% q.answers.each do |a| %>
                <% a.user_answers.each do |u| %>
                  <% if !useranswers.include?(u.user_id) %>
                    <% useranswers << u.user_id %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <% if false %>
              <% useranswers.each do |us| %>
                <%= showImage2(:small, User.find(us), true) %>
              <% end %>
            <% end %>
            <%= build_medialistNew(User.where("id IN (?)", useranswers), "users", nil) %>
          </div>

         <% when "objekte_ideen" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.ideas.order(rating: :desc), "ideas", "user") %>
          </div>

        <% when "objekte_jury" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.madvisors.where('grade=? or grade=?', "Jury-Mitglied", "Jury-Vorsitz"), "madvisors", "user") %>
          </div>

        <% when "objekte_preise" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.prices, "prices", nil) %>
          </div>

        <% when "objekte_bewertungskriterien" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.crits, "crits", nil) %>
          </div>

         <% when "objekte_ausschreibungsangebote" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.mdetails.where('mtype=?', "ausschreibungsangebote"), "mdetails", nil) %>
          </div>

        <% when "objekte_sponsorenengagements" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.msponsors, "msponsors", "company") %>
          </div>
          
        <% when "objekte_eintrittskarten" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.tickets, "tickets", nil) %>
          </div>

        <% when "objekte_crowdideenbewertung" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.mratings, "mratings", "user") %>
          </div>

        <% when "objekte_ansprechpartner" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.madvisors, "madvisors", "user") %>
          </div>

        <% when "objekte_projektberechtigungen" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.madvisors.where('role=?', @mobject.mtype), "madvisors", "user") %>
          </div>

        <% when "objekte_gruppenmitglieder" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.madvisors.where('role=?', @mobject.mtype), "madvisors", "user") %>
          </div>

        <% when "objekte_signstat" %>
          <% if @mobject.mtype == "kampagnen" %>
            <% @stats = SignageHit.select("date(created_at) as datum, count(mkampagne) as summe").where('mkampagne=?', @mobject.id).group("date(created_at)") %>
            <% @objs = SignageHit.select("mstandort as obj, count(mstandort) as summe").where('mkampagne=?', @mobject.id).group("mstandort") %>
          <% end %>
            <% if @mobject.mtype == "standorte" %>
            <% @stats = SignageHit.select("date(created_at) as datum, count(mstandort) as summe").where('mstandort=?', @mobject.id).group("date(created_at)") %>
            <% @objs = SignageHit.select("mkampagne as obj, count(mkampagne) as summe").where('mstandort=?', @mobject.id).group("mkampagne") %>
          <% end %>

          <%= header((I18n.t :anzahl)) %> 
          <div id="signchartzeit"></div>
          <br><br>
          <% if @mtype == "kampagnen" %>
            <%= header((I18n.t :standorte)) %> 
          <% end %>
          <% if @mtype == "standorte" %>
            <%= header((I18n.t :kampagnen)) %> 
          <% end %>
          <div id="signchartobjekt"></div>
          <br><br>
          
          <% num =0 %>
          <% @objs.each do |o| %>
            <% num = num + 1 %>
            <%= header(Mobject.find(o.obj).name) %> 
            <div id="signchartobj<%= num %>"></div>
            <br><br>
          <% end %>

        <% when "objekte_signcal" %>
        
          <div class="row">
              <div class='col-xs-12'>
                <div class='panel-body'>
                  <% case @c_scope %>
                    <% when "aufwand" %>
                      <% btn_sa = "active" %>
                      <% btn_sc = "inactive" %>
                    <% when "kosten" %>
                      <% btn_sa = "inactive" %>
                      <% btn_sc = "active" %>
                  <% end %>
                  <% case @c_mode %>
                    <% when "Woche" %>
                      <% btn_m = "inactive" %>
                      <% btn_y = "inactive" %>
                      <% btn_w = "active" %>
                      <% btn_d = "inactive" %>
                    <% when "Monat" %>
                      <% btn_m = "active" %>
                      <% btn_y = "inactive" %>
                      <% btn_w = "inactive" %>
                      <% btn_d = "inactive" %>
                    <% when "Jahr" %>
                      <% btn_y = "active" %>
                      <% btn_m = "inactive" %>
                      <% btn_w = "inactive" %>
                      <% btn_d = "inactive" %>
                    <% when "Datum" %>
                      <% btn_y = "inactive" %>
                      <% btn_m = "inactive" %>
                      <% btn_w = "inactive" %>
                      <% btn_d = "active" %>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_signcal",  :year => @c_year, :month => @c_month, :mode => "Woche", :week => @c_week, :day => @c_day) do %>
                    <span><i class="btn btn-<%= btn_w %> fa fa-calendar"> <%= @c_week %></i></span>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_signcal", :year => @c_year, :month => @c_month, :mode => "Monat", :week => @c_week, :day => @c_day) do %>
                    <span><i class="btn btn-<%= btn_m %> fa fa-calendar"> <%= @c_month %></i></span>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_signcal",  :year => @c_year, :month => @c_month, :mode => "Jahr", :week => @c_week, :day => @c_day)  do %>
                    <span><i class="btn btn-<%= btn_y %> fa fa-calendar"> <%= @c_year %></i></span>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_signcal", :dir => "<", :year => @c_year, :month => @c_month, :mode => @c_mode, :week => @c_week,  :day => @c_day)  do %>
                    <i class="btn btn-primary fa fa-chevron-left"></i>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_signcal", :dir => ">", :year => @c_year, :month => @c_month, :mode => @c_mode, :week => @c_week, :day => @c_day) do %>
                    <i class="btn btn-primary fa fa-chevron-right"></i>
                  <% end %>
                </div>
              </div>
          </div>
          <% if @mobject.mtype == "kampagnen" %>
            <% session[:signage_cal_mode] = "kam" %>
            <%= build_cal(@c_mode,"signage_cals", "locations", @mobject.id, @c_day.to_s) %>
          <% end %>
          <% if @mobject.mtype == "standorte" %>
            <% session[:signage_cal_mode] = "loc" %>
            <%= build_cal(@c_mode,"signage_cals", "campaigns", @mobject.id, @c_day.to_s) %>
          <% end %>

        <% when "objekte_signlocshow" %>
          <%= controller.redirect_to(home_index18_url :standort => @mobject.id) %>
        <% when "objekte_signkamshow" %>
          <%= controller.redirect_to(home_index18_url :kampagne => @mobject.id) %>

        <% when "objekte_ansprechpartner" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.madvisors, "madvisors", "user") %>
          </div>

        <% when "objekte_ressourcenplanung" %>
          <div class="row">
              <div class='col-xs-12'>
                <div class='panel-body'>

                  <% @header = [] %>
                  <% @data = [] %>
                  <% @header = %w[Jan Feb Mar Apr May Jun Jul Aug Sep Okt Nov Dez] %>
                  <% for i in 1..12 %>
                    <% @data << i %>
                  <% end %>
                  
                  <% case @c_scope %>
                    <% when "aufwand" %>
                      <% btn_sa = "active" %>
                      <% btn_sc = "inactive" %>
                    <% when "kosten" %>
                      <% btn_sa = "inactive" %>
                      <% btn_sc = "active" %>
                  <% end %>
                  
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_ressourcenplanung", :year => @c_year, :scope => @c_scope)  do %>
                    <span><i class="btn btn-active fa fa-calendar"> <%= @c_year %></i></span>
                  <% end %>

                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_ressourcenplanung", :year => @c_year, :scope => "kosten")  do %>
                    <span><i class="btn btn-<%= btn_sc %> fa fa-euro"></i></span>
                  <% end %>
                   <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_ressourcenplanung", :year => @c_year, :scope => "aufwand")  do %>
                    <span><i class="btn btn-<%= btn_sa %> fa fa-safari"></i></span>
                  <% end %>
                  
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_ressourcenplanung", :dir => "<", :year => @c_year, :mode => @c_mode, :scope => @c_scope )  do %>
                    <i class="btn btn-primary fa fa-chevron-left"></i>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_ressourcenplanung", :dir => ">", :year => @c_year, :mode => @c_mode , :scope => @c_scope) do %>
                    <i class="btn btn-primary fa fa-chevron-right"></i>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_ressourcenplanung", :year => @c_year, :month => @c_month, :mode => @c_mode, :scope => @c_scope, :export => true) do %>
                    <span><i class="btn btn-inactive fa fa-book"></i></span>
                  <% end %>

                 <br><br>
                 <% @userdata = [] %>
                 
                 <% @gruppenmitglieder = @mobject.madvisors %>

                 <% @gruppenmitglieder.each do |gm| %>
                 
                 <% @tmpdata = [] %>
                 <% @tmpdata << gm.user_id %>
                 
                 <table class="table">
                    <tr>
                      <td></td>
                      <td></td>
                      <td colspan= <%= @header.length %>></td> 
                    </tr>
                    <tr>
                      <th colspan="2"><%= showImage2(:small, User.find(gm.user.id), true) + gm.user.name + " " + gm.user.lastname %></th>
                        <% @total = [] %>
                        <% @totalt = [] %>
                        <% for i in 0..@header.length-1 do %>
                          <!-- set initialize total per column -->
                          <% @total[i] = 0 %>
                          <% @totalt[i] = 0 %>
                          <!-- set color of header according to actual day, wekk or month -->
                          <% if Date.today.strftime('%m').to_i == @data[i] and Date.today.strftime('%Y').to_i == @c_year.to_i %>
                                <th class="warning">
                          <% else %>
                                <th>
                          <% end %>
                          <%= @header[i] %>
                        </th>
                      <% end %>
                    </tr>

                    <% myobs = [] %>
                    <% gm.user.madvisors.each do |a| %>
                      <% myobs << a.mobject_id %>
                    <% end %>
                    <% @mymobjects = Mobject.where('mtype=? and id IN (?)',"projekte", myobs) %>

                    <% @mobdata = [] %>

                    <% @mymobjects.each do |w| %>
                    
                      <tr>            

                        <% plans = [] %>
                        <% @plannings = Planning.where('mobject_id=? and user_id=? and costortime=? and jahr=?', w.id, gm.user.id, @c_scope, @c_year.to_s) %>
                        <% @plannings.each do |p| %>
                          <% h = Hash.new %>
                          <% if @c_scope == "kosten" %>
                            <% kapa = p.amount %>
                          <% end %>
                          <% if @c_scope == "aufwand" %>
                            <% kapa = p.amount*20/100 %>
                          <% end %>
                          <% h = {:id => p.id, :monat => p.monat.to_i, :kapa => kapa} %>
                          <% plans << h %>
                        <% end %>

                        <td>
                          <%= showFirstImage2(:small, w,w.mdetails) %>
                        </td>
                        <td>
                          <%= w.name %>
                        </td>

                        <% @plan = [] %>
                        <% for i in 0..@header.length-1 do %>
                        
                          <% if @c_scope == "kosten" %>
                          
                            <% moto = 0 %>
                            <% for k in 0..plans.length-1 do %>
                              <% if plans[k][:monat].to_i == @data[i].to_i %>
                                <% moto = moto + plans[k][:kapa] %>
                              <% end %>
                            <% end %>
                            
                            <% if moto > 0 %>
                              <td class="color_kapa_booked" align="right">
                                <% if false %>
                				        <%= link_to new_planning_path(:mobject_id => w.id, :user_id => current_user.id, :month => @data[i], :year => @c_year, :scope => @c_scope) do %>
                                  <i class="btn btn-primary btn-xs fa fa-plus"></i>
                                <% end %>
                                <% end %>
                               <%= moto.to_s+" " +(I18n.t :waehrung) %><br>
                            <% else %>
                                <td>
                                <% if false %>
                				        <%= link_to new_planning_path(:mobject_id => w.id, :user_id => current_user.id, :month => @data[i], :year => @c_year, :scope => @c_scope) do %>
                                  <i class="btn btn-primary btn-xs fa fa-plus"></i>
                                <% end %>
                                <% end %>
                            <% end %>
                            
                            <% @plan << [i, moto] %>

                            </td>
                          <% end %>
                        
                          <% if @c_scope == "aufwand" %>
                            <% kapa = false %>
                            <% for k in 0..plans.length-1 do %>
                              <% if plans[k][:monat].to_i == @data[i].to_i %>
                                <td class="color_kapa_booked" align="right">
                                <%= plans[k][:kapa].to_s + " " + (I18n.t :personentage) %><br>

                                <% @plan << [@data[i], plans[k][:kapa]] %>

                                <% if false %>
                				        <%= link_to edit_planning_path(:id => plans[k][:id]) do %>
                                  <i class="btn btn-primary btn-xs fa fa-pencil"></i>
                                <% end %>
                				        <%= link_to Planning.find(plans[k][:id]), method: :delete, data: { confirm: (I18n.t :sindsiesicher) } do %>
                                  <i class="btn btn-danger btn-xs fa fa-trash"></i>
                                <% end %>
                                <% end %>
                                <% @total[i] = @total[i] + plans[k][:kapa] %>
                                <% kapa = true %>
                              <% end %>
                            <% end  %>
                            <% if !kapa %>
                                <td>
                                <% if false %>
                				        <%= link_to new_planning_path(:mobject_id => w.id, :user_id => current_user.id, :month => @data[i], :year => @c_year, :scope => @c_scope) do %>
                                  <i class="btn btn-primary btn-xs fa fa-plus"></i>
                                <% end %>
                                <% end %>
                            <% end %>
                            </td>

                          <% end %>

                        <% end %>

                      </tr>

                      <!--/* hha-->

                      <tr>            

                        <% tts = [] %>
                        <% @timetracks = Timetrack.select("jahrmonat as gdate, sum(amount) as sum").where('user_id=? and costortime=? and mobject_id=? and datum >=? and datum <=?', gm.user.id, @c_scope, w.id, @date_start, @date_end).group("jahrmonat").order("gdate") %>
                        <% @timetracks.each do |t| %>
                          <% h = Hash.new %>
                          <% if @c_scope == "kosten" %>
                            <% ist = t.sum %>
                          <% end %>
                          <% if @c_scope == "aufwand" %>
                            <% ist = t.sum / 8 %>
                          <% end %>
                          <% h = {:monat => t.gdate[5,2], :kapa => ist.to_f } %>
                          <% tts << h %>
                        <% end %>

                        <td>
                          <% if false %>
                          <%= showFirstImage2(:small, w,w.mdetails) %>
                          <% end %>
                        </td>
                        <td>
                          <% if false %>
                          <%= w.name %>
                          <% end %>
                        </td>

                        <% @ist = [] %>
                        <% for i in 0..@header.length-1 do %>

                          <% if @c_scope == "kosten" %>
                          
                            <% moto = 0 %>
                            <% for k in 0..tts.length-1 do %>
                              <% if tts[k][:monat].to_i == @data[i].to_i %>
                                <% moto = moto + tts[k][:kapa] %>
                              <% end %>
                            <% end %>
                            
                            <% if moto > 0%>
                              <td class="color_kapa_booked" align="right">
                                <% if false %>
                				        <%= link_to new_planning_path(:mobject_id => w.id, :user_id => current_user.id, :month => @data[i], :year => @c_year, :scope => @c_scope) do %>
                                  <i class="btn btn-primary btn-xs fa fa-plus"></i>
                                <% end %>
                                <% end %>
                               <%= moto.to_s+ " " +( I18n.t :waehrung) %><br>
                            <% else %>
                                <td>
                                <% if false %>
                				        <%= link_to new_planning_path(:mobject_id => w.id, :user_id => current_user.id, :month => @data[i], :year => @c_year, :scope => @c_scope) do %>
                                  <i class="btn btn-primary btn-xs fa fa-plus"></i>
                                <% end %>
                                <% end %>
                            <% end %>
                            </td>
                            
                            <% @ist << [@data[i], moto] %>

                          <% end %>
                        
                          <% if @c_scope == "aufwand" %>
                            <% kapa = false %>
                            <% for k in 0..tts.length-1 do %>
                              <% if tts[k][:monat].to_i == @data[i].to_i %>
                                <% @ist << [@data[i], tts[k][:kapa]] %>
                                <td class="color_kapa_booked" align="right">
                                <%= sprintf("%5.1f "+(I18n.t :personentage), tts[k][:kapa]) %><br>
                                <% if false %>
                				        <%= link_to edit_planning_path(:id => plans[k][:id]) do %>
                                  <i class="btn btn-primary btn-xs fa fa-pencil"></i>
                                <% end %>
                				        <%= link_to Planning.find(plans[k][:id]), method: :delete, data: { confirm: (I18n.t :sindsiesicher) } do %>
                                  <i class="btn btn-danger btn-xs fa fa-trash"></i>
                                <% end %>
                                <% end %>
                                <% @totalt[i] = @totalt[i] + tts[k][:kapa] %>
                                <% kapa = true %>
                              <% end %>
                            <% end  %>
                            <% if !kapa %>
                                <td>
                                <% if false %>
                				        <%= link_to new_planning_path(:mobject_id => w.id, :user_id => current_user.id, :month => @data[i], :year => @c_year, :scope => @c_scope) do %>
                                  <i class="btn btn-primary btn-xs fa fa-plus"></i>
                                <% end %>
                                <% end %>
                            <% end %>
                            </td>
                          <% end %>

                        <% end %>

                      </tr>
                      <% @mobdata << [w.id , @plan, @ist] %>


                    <% end %>
                    <% @tmpdata << @mobdata %>
                    <% @userdata << @tmpdata %>

                  <!-- finally add totals and progress bar-->
                  <% if @c_scope == "aufwand" %>
                    <tr>
                      <td><%= I18n.t :totalplan %></td>
                      <td></td>
                      <% for i in 0..@header.length-1 do %>
                        <td align="right">
                        <%= sprintf("%5.1f "+( I18n.t :personentage), @total[i]) %>
                        </td>
                      <% end %>
                    </tr>
                    <tr>
                      <td><%= I18n.t :totalist %></td>
                      <td></td>
                      <% for i in 0..@header.length-1 do %>
                        <td align="right">
                        <%= sprintf("%5.1f "+(I18n.t :personentage), @totalt[i]) %>
                        </td>
                      <% end %>
                    </tr>
                    <tr>
                      <td></td>
                      <td></td>
                      <% for i in 0..@header.length-1 do %>
                        <td>
                          
                        <% showme = false %>
                        <% if Date.today.strftime('%Y').to_i < @c_year.to_i %>
                          <% showme = false %>
                        <% end %>
                        <% if Date.today.strftime('%Y').to_i > @c_year.to_i %>
                          <% showme = true %>
                        <% end %>
                        <% if Date.today.strftime('%m').to_i >= @data[i] and Date.today.strftime('%Y').to_i == @c_year.to_i %>
                          <% showme = true %>
                        <% end %>

                        <% if showme %>
                          <div class="progress">
                          <% if (@total[i] - @totalt[i]).abs > 5 %>
                            <class="riskhoch">
                            <div class="progress-bar progress-bar-danger" role="progressbar" style="width: <%= 100 %>%" >
                          <% end %>
                          <% if (@total[i] - @totalt[i]).abs > 3 and (@total[i] - @totalt[i]).abs <= 5 %>
                            <class="riskmittel">
                            <div class="progress-bar progress-bar-warning" role="progressbar" style="width: <%= 100 %>%" >
                          <% end %>
                          <% if (@total[i] - @totalt[i]).abs <= 3 %>
                            <class="risktief">
                            <div class="progress-bar progress-bar-success" role="progressbar" style="width: <%= 100 %>%" >
                          <% end %>
                          </div>
                        <% end %>
                        
                        </td>
                      <% end %>
                    </tr>
                  <% end %>
                
                </table>
                <% end %>
                
              </div>
            </div>

            <% if @export %>
              <% @filename = exportWriterRessourcen(@userdata, @header) %>
              <% link_to @filename, @filename.remove("public") %>
    	        <%= link_to @filename.remove("public") do %>
                <span><i class="btn btn-active fa fa-cloud-download"></i></span>
              <% end %>
            <% end %>
            
            <% @userdata %>

          </div>

        <% when "objekte_auftragscontrolling" %>
          <div class="panel-body">

              <% case @c_scope %>
                <% when "aufwand" %>
                  <% btn_sa = "active" %>
                  <% btn_sc = "inactive" %>
                <% when "kosten" %>
                  <% btn_sa = "inactive" %>
                  <% btn_sc = "active" %>
              <% end %>
              <% case @c_mode %>
                <% when "Monat" %>
                  <% btn_m = "active" %>
                  <% btn_y = "inactive" %>
                  <% btn_a = "inactive" %>
                <% when "Jahr" %>
                  <% btn_y = "active" %>
                  <% btn_m = "inactive" %>
                  <% btn_a = "inactive" %>
                <% when "alles" %>
                  <% btn_y = "inactive" %>
                  <% btn_m = "inactive" %>
                  <% btn_a = "active" %>
              <% end %>
              <% @date_start %>
              <% @date_end %>

              <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_auftragscontrolling", :year => @c_year, :month => @c_month, :mode => "alles", :scope => @c_scope)  do %>
                <span><i class="btn btn-<%= btn_a %> fa fa-fullscreen"> alles</i></span>
              <% end %>
              <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_auftragscontrolling", :year => @c_year, :month => @c_month, :mode => "Jahr", :scope => @c_scope)  do %>
                <span><i class="btn btn-<%= btn_y %> fa fa-calendar"> <%= @c_year %></i></span>
              <% end %>
              
              <% if @c_mode != "alles" %>
                <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_auftragscontrolling", :dir => "<", :year => @c_year, :month => @c_month, :mode => @c_mode, :scope => @c_scope) do %>
                  <i class="btn btn btn-primary fa fa-chevron-left"></i>
                <% end %>
                <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_auftragscontrolling", :dir => ">", :year => @c_year, :month => @c_month, :mode => @c_mode, :scope => @c_scope) do %>
                  <i class="btn btn-primary fa fa-chevron-right"></i>
                <% end %>
              <% end %>
              
              <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_auftragscontrolling", :year => @c_year, :month => @c_month, :mode => @c_mode, :scope => "kosten") do %>
                <span><i class="btn btn-<%= btn_sc %> fa fa-euro"></i></span>
              <% end %>
              <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_auftragscontrolling", :year => @c_year, :month => @c_month, :mode => @c_mode, :scope => "aufwand") do %>
                <span><i class="btn btn-<%= btn_sa %> fa fa-safari"></i></span>
              <% end %>
              
              <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_auftragscontrolling", :year => @c_year, :month => @c_month, :mode => @c_mode, :scope => @c_scope, :export => true) do %>
                <span><i class="btn btn-inactive fa fa-book"></i></span>
              <% end %>
              
             <br><br>

            <!--Sicht Monat-->
            <% if @c_mode == "alles" %>
              <% @tts = Timetrack.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and costortime=?',@mobject.id, @c_scope).group("jahrmonat").order(:jahrmonat) %>
              <% @pts = Planning.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and costortime=?',@mobject.id, @c_scope).group("jahrmonat").order(:jahrmonat) %>
            <% else %>        
              <% @tts = Timetrack.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and costortime=? and datum>=? and datum<=?', @mobject.id, @c_scope, @date_start, @date_end).group("jahrmonat").order(:jahrmonat) %>
              <% if @c_mode == "Monat" %>
                <% @pts = Planning.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and costortime=? and jahr=? and monat=?', @mobject.id, @c_scope, @c_year.to_s, @c_month.to_s).group("jahrmonat").order(:jahrmonat) %>
              <% end %>
              <% if @c_mode == "Jahr" %>
                <% @pts = Planning.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and costortime=? and jahr=?',@mobject.id, @c_scope, @c_year.to_s).group("jahrmonat").order(:jahrmonat) %>
              <% end %>
            <% end %>
            
            <% @range = [] %>
            <% @start = Date.today.strftime("%Y-m") %>
            <% @ende = @start %>
            <% @startp = @start  %>
            <% @endep = @start  %>
            
            <% if @tts %>
              <% @start = @tts.first.jahrmonat if @tts.first %>
              <% @ende = @tts.last.jahrmonat if @tts.last %>
            <% end %>
            <% if @pts %>
              <% @startp = @pts.first.jahrmonat if @pts.first %>
              <% @endep = @pts.last.jahrmonat if @pts.last %>
            <% end %>
            
            <% if @startp < @start %>
              <% @start = @startp %>
            <% end %>
            <% if @endep > @ende %>
              <% @ende = @endep %>
            <% end %>

            <% vjahr = @start[0..3].to_i %>
            <% vmonat = @start[5..6].to_i %>
            <% vdatum = @start %>
            <% @range = [] %>
            <% while vdatum <= @ende %>

              <% @range << vdatum %>

              <% if vmonat == 12 %>
                <% vmonat = 1 %>
                <% vjahr = vjahr + 1 %>
              <% else %>
                <% vmonat = vmonat + 1 %>
              <% end %>

              <% monats = vmonat.to_s %>
              <% jahrs = vjahr.to_s %>
              <% if monats.length == 1 %>
              <%   monats = "0" + monats %>
              <% end %>
              <% vdatum = jahrs + "-" + monats %>
              
            <% end %>
            <% @range %><br><br>

            <% @plans = [] %>
            <% @pts.each do |t| %>
              <% @plans << [t.jahrmonat, t.summe] %>
            <% end %>
            
           <% @ists = [] %>
            <% @tts.each do |t| %>
              <% @ists << [t.jahrmonat, t.summe] %>
            <% end %>

            <% @istsoll = [] %>
            <% @istsoll << ['kategorie', 'IST','PLAN'] %>
            <% for i in 0..@range.length-1 %>
            
                <% plan = 0 %>
                <% found = false %>
                <% for k in 0..@plans.length-1 %>
                  <% if !found %>
                    <% if @plans[k][0] == @range[i] %>
                      <% plan = @plans[k][1] %>
                      <% found = true %>
                    <% end %>
                  <% end %>
                <% end %>

                <% ist = 0 %>
                <% found = false %>
                <% for k in 0..@ists.length-1 %>
                  <% if !found %>
                    <% if @ists[k][0] == @range[i] %>
                      <% ist = @ists[k][1] %>
                      <% found = true %>
                    <% end %>
                  <% end %>
                <% end %>

                <% if @c_scope == "aufwand" %>
                  <% h = [@range[i], ist, (plan * 170) / 100] %>
                <% end %>
                <% if @c_scope == "kosten" %>
                  <% h = [@range[i], ist, plan] %>
                <% end %>
                <% @istsoll << h %>

            <% end %>
            <% @istsoll %>
            
            <% @istsollkum = [] %>
            <% @istsollkum << ['kategorie', 'IST','PLAN'] %>
              <% for i in 1..@istsoll.length-1 %>
                <% if i==1 %>
                  <% @istsollkum << [@istsoll[i][0], @istsoll[i][1].to_i, @istsoll[i][2]]%>
                <% else %>
                  <% @istsollkum << [@istsoll[i][0], @istsollkum[i-1][1].to_f + @istsoll[i][1].to_f, @istsollkum[i-1][2].to_f + @istsoll[i][2].to_f] %>
                <% end %>
              <% end %>
            <% @istsollkum %>

            <div id="auftragschartallkum"></div>
            <br><br>
            <div id="auftragschartall"></div>
            <br><br>

            <!--Sicht User-->
            <% if @c_mode == "alles" %>
              <% @tts = Timetrack.select("user_id, sum(amount) as summe").where('mobject_id=? and costortime=?',@mobject.id, @c_scope).group("user_id") %>
              <% @pts = Planning.select("user_id, sum(amount) as summe").where('mobject_id=? and costortime=?',@mobject.id, @c_scope).group("user_id") %>
            <% else %>        
              <% @tts = Timetrack.select("user_id, sum(amount) as summe").where('mobject_id=? and costortime=? and datum>=? and datum<=?', @mobject.id, @c_scope, @date_start, @date_end).group("user_id") %>
              <% if @c_mode == "Monat" %>
                <% @pts = Planning.select("user_id, sum(amount) as summe").where('mobject_id=? and costortime=? and jahr=? and monat=?', @mobject.id, @c_scope, @c_year.to_s, @c_month.to_s).group("user_id") %>
              <% end %>
              <% if @c_mode == "Jahr" %>
                <% @pts = Planning.select("user_id, sum(amount) as summe").where('mobject_id=? and costortime=? and jahr=?',@mobject.id, @c_scope, @c_year.to_s).group("user_id") %>
              <% end %>
            <% end %>
            <% @plans = [] %>
            <% @pts.each do |p| %>
              <% if p.summe > 0 %>
                <% h = Hash.new %>
                <% if @c_scope == "aufwand" %>
                  <% h = {:user_id => p.user_id, :kapa => (p.summe * 170) / 100} %>
                <% end %>
                <% if @c_scope == "kosten" %>
                  <% h = {:user_id => p.user_id, :kapa => p.summe} %>
                <% end %>
                <% @plans << h %>
              <% end %>
            <% end %>

            <% @istsollau = [] %>
            <% @istsollau << ['kategorie', 'IST','PLAN'] %>
            <% @tts.each do |t| %>
              <% kapa = 0 %>
              <% for i in 0..@plans.length-1 %>
                <% if @plans[i][:user_id] == t.user_id %>
                  <% kapa = @plans[i][:kapa] %>
                <% end %>
              <% end %>
              <% @user = User.find(t.user_id) %>
              <% @istsollau << [@user.name + " " + @user.lastname, t.summe, kapa] %>
            <% end %>
            <% @istsollau %>
            <div id="chartalluser"></div>
            <br><br>

            <div class="row">
  
                <% @iso = [] %>
                <% @isoall = [] %>
                <% @isoallrep = [] %>
                <% @timetracks = Timetrack.select("user_id").where('mobject_id=? and costortime=?', @mobject.id, @c_scope).distinct %>
                <% @timetracks.each do |u| %>
                  <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-6">
                    <div>
                      <% @user = User.find(u.user_id) %>
                      <%= header(@user.name + " " + @user.lastname) %>
                      
                      <!--Sicht Monat/MA -->
                      <% if @c_mode == "alles" %>
                        <% @tts = Timetrack.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and user_id=? and costortime=?',@mobject.id, u.user_id, @c_scope).group("jahrmonat") %>
                        <% @pts = Planning.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and user_id=? and costortime=?',@mobject.id, u.user_id, @c_scope).group("jahrmonat") %>
                      <% else %>        
                        <% @tts = Timetrack.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and user_id=? and costortime=? and datum>=? and datum<=?', @mobject.id, u.user_id, @c_scope, @date_start, @date_end).group("jahrmonat") %>
                        <% if @c_mode == "Monat" %>
                          <% @pts = Planning.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and user_id=? and costortime=? and jahr=? and monat=?', @mobject.id, u.user_id, @c_scope, @c_year.to_s, @c_month.to_s).group("jahrmonat") %>
                        <% end %>
                        <% if @c_mode == "Jahr" %>
                          <% @pts = Planning.select("jahrmonat, sum(amount) as summe").where('mobject_id=? and user_id=? and costortime=? and jahr=?',@mobject.id, u.user_id, @c_scope, @c_year.to_s).group("jahrmonat") %>
                        <% end %>
                      <% end %>
                      
                      <% @plans = [] %>
                      <% @pts.each do |t| %>
                        <% @plans << [t.jahrmonat, t.summe] %>
                      <% end %>
                      <% @ists = [] %>
                      <% @tts.each do |t| %>
                        <% @ists << [t.jahrmonat, t.summe] %>
                      <% end %>
                      
                      <% @istsollall = [] %>
                      <% @istsollallgraph = [] %>
                      <% @istsollall << ['user', 'kategorie', 'IST','PLAN'] %>
                      <% @istsollallgraph << ['kategorie', 'IST','PLAN'] %>
                      <% for i in 0..@range.length-1 %>
                      
                          <% plan = 0 %>
                          <% found = false %>
                          <% for k in 0..@plans.length-1 %>
                            <% if !found %>
                              <% if @plans[k][0] == @range[i] %>
                                <% plan = @plans[k][1] %>
                                <% found = true %>
                              <% end %>
                            <% end %>
                          <% end %>
          
                          <% ist = 0 %>
                          <% found = false %>
                          <% for k in 0..@ists.length-1 %>
                            <% if !found %>
                              <% if @ists[k][0] == @range[i] %>
                                <% ist = @ists[k][1] %>
                                <% found = true %>
                              <% end %>
                            <% end %>
                          <% end %>
          
                          <% if @c_scope == "aufwand" %>
                            <% h = [@user.id, @range[i], ist, (plan * 170) / 100] %>
                          <% end %>
                          <% if @c_scope == "kosten" %>
                            <% h = [@user.id, @range[i], ist, plan] %>
                          <% end %>
                          
                          <% @istsollall << h %>
                          <% @istsollallgraph << h[1..3] %>
          
                      <% end %>
                      
                      <% @isoall << @istsollallgraph %>
                      <% @isoallrep << @istsollall %>
                      
                      <div id="<%="chart" + (@isoall.length-1).to_s %>"></div>

                    </div>
                  </div>
                <% end %>
            </div>
            
            <% if @export %>
              <% @filename = exportWriter(@mobject, @istsoll, @istsollkum, @istsollau, @isoallrep) %>
              <% link_to @filename, @filename.remove("public") %>
    	        <%= link_to @filename.remove("public") do %>
                <span><i class="btn btn-active fa fa-cloud-download"></i></span>
              <% end %>
            <% end %>
            
          </div>

        <% when "objekte_projektdashboard" %>
          <div class="panel-body">
            
            <% @prolist  = [@mobject.id.to_i] %>
            <% wo_iterate(@mobject.id, true, @prolist) %>
            <% @prolist %>
            <% @projects = Mobject.where("mtype=? and id in (?)", "projekte", @prolist) %>

            <div class="row">
              <% @projects.each do |m| %>
                <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6 col-xl-6">
                  <div class="panel panel-dashboard">
                    <div class="row">
                      <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xl-6">
                        <%= content_tag(:i, nil, class:"fa fa-" + getinfo2(:projekte)["info"], style:"font-size:4em") %>
                      </div>
                      <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xl-6">
                        <huge>
                        <%= m.name %><br><br>
                        </huge>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xl-6">
                        <div class="row" align="Center">
                          <div id="costchart<%= m.id %>"></div>
                        </div>
                      </div>
                      <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xl-6">
                        <div class="row" align="Center">
                          <div id="effortchart<%= m.id %>"></div>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xl-6">
                        <huge>
                        <p id="cost<%= m.id %>"></p>
                        </huge>
                      </div>
                      <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 col-xl-6">
                        <huge>
                        <p id="effort<%= m.id %>"></p>
                        </huge>
                      </div>
                    </div>
                  </div>
                </div>  
              <% end %>
            </div>
            
          </div>

        <% when "objekte_blog" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.comments.order(created_at: :desc), "comments", "user") %>
          </div>

        <% when "objekte_fragen" %>
          <%= @ques %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.questions.order(:sequence), "questions", "user") %>
          </div>

        <% when "objekte_artikel" %>
          <div class="panel-body">
              <%= build_medialistNew(PublicationArticle.where('publication=?',@mobject.id).order(:sequence), "publikation_artikel", "artikel") %>
          </div>

        <% when "objekte_publikationen" %>
          <div class="panel-body">
              <%= build_medialistNew(PublicationArticle.where('article=?',@mobject.id).order(created_at: :desc), "publikation_artikel", "publikationen") %>
          </div>

        <% when "objekte_substruktur" %>
          <div class="panel-body">
            <%= build_medialistNew(Mobject.where('parent=?',@mobject.id).order(created_at: :desc), "mobjects", "user") %>
          </div>

        <% when "objekte_teilnehmerveranstaltung" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.madvisors.where('role=?',"eventteilnehmer"), "madvisors", "user") %>
          </div>

        <% when "objekte_kalendervermietungen" %>
          <div class="row">
              <div class='col-xs-12'>
                <div class='panel-body'>
                  <% case @c_mode %>
                    <% when "Woche" %>
                      <% btn_m = "inactive" %>
                      <% btn_y = "inactive" %>
                      <% btn_w = "active" %>
                      <% btn_d = "inactive" %>
                    <% when "Monat" %>
                      <% btn_m = "active" %>
                      <% btn_y = "inactive" %>
                      <% btn_w = "inactive" %>
                      <% btn_d = "inactive" %>
                    <% when "Jahr" %>
                      <% btn_y = "active" %>
                      <% btn_m = "inactive" %>
                      <% btn_w = "inactive" %>
                      <% btn_d = "inactive" %>
                    <% when "Datum" %>
                      <% btn_y = "inactive" %>
                      <% btn_m = "inactive" %>
                      <% btn_w = "inactive" %>
                      <% btn_d = "active" %>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_kalendervermietungen",  :year => @c_year, :month => @c_month, :mode => "Woche", :week => @c_week, :day => @c_day) do %>
                    <span><i class="btn btn-<%= btn_w %> fa fa-calendar"> <%= @c_week %></i></span>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_kalendervermietungen", :year => @c_year, :month => @c_month, :mode => "Monat", :week => @c_week, :day => @c_day) do %>
                    <span><i class="btn btn-<%= btn_m %> fa fa-calendar"> <%= @c_month %></i></span>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_kalendervermietungen",  :year => @c_year, :month => @c_month, :mode => "Jahr", :week => @c_week, :day => @c_day)  do %>
                    <span><i class="btn btn-<%= btn_y %> fa fa-calendar"> <%= @c_year %></i></span>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_kalendervermietungen", :dir => "<", :year => @c_year, :month => @c_month, :mode => @c_mode, :week => @c_week,  :day => @c_day)  do %>
                    <i class="btn btn-primary fa fa-chevron-left"></i>
                  <% end %>
                  <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_kalendervermietungen", :dir => ">", :year => @c_year, :month => @c_month, :mode => @c_mode, :week => @c_week, :day => @c_day) do %>
                    <i class="btn btn-primary fa fa-chevron-right"></i>
                  <% end %>
                </div>
              </div>
          </div>
          <%= build_cal(@c_mode,"vermietungen", "locations", @mobject.id, @c_day.to_s) %>

          <div class="panel-body">
          	<table class="table table-striped">
              <thead>
                <tr>
                  <th></th>
                  <th colspan=2><%= I18n.t :gemietetvon %></th>
                  <th colspan=2><%= I18n.t :wann %></th>
                </tr>
              </thead>
              <body>
                <% @mobject.mcalendars.each do |ca| %>
                  <tr>
                    <td>
          				    <% if user_signed_in? %>
          				      <% if (ca.mobject.owner_type == "User" and ca.mobject.owner_id == current_user.id) or (ca.mobject.owner_type == "Company" and ca.mobject.owner.user_id == current_user.id) %>
          				        <% if !ca.confirmed %>
                            <%= link_to mobject_path(:id => ca.mobject_id, :confirm_id => ca.id, :topic => "objekte_kalendervermietungen") do %>
                              <i class="btn btn-primary btn-xs fa fa-question"></i>
                            <% end %>
                          <% else %>
                            <%= link_to mobject_path(:id => ca.mobject_id, :noconfirm_id => ca.id, :topic => "objekte_kalendervermietungen") do %>
                              <i class="btn btn-primary btn-xs fa fa-thumbs-up"></i>
                            <% end %>
                          <% end %>
          				      <% end %>
            				    <% if ca.user_id == current_user.id %>
            				      <% if false %>
                            <%= link_to listaccount_index_path :user_id => current_user.id, :user_id_ver => ca.mobject.owner_id, :company_id_ver => ca.mobject.owner_id, :ref => "Vergtung an "+ ca.mobject.name + " " + ca.date_from.strftime("%d.%m.%Y") + " " + ca.time_from.to_s + "Uhr -" + ca.date_to.strftime("%d.%m.%Y") + " " + ca.time_to.to_s + " Uhr", :object_name => "Mobject", :object_id => ca.mobject.id, :amount => 0 do %>
                              <i class="btn btn-primary btn-xs fa fa-euro"></i>
                            <% end %>
                  				<% end %>
          				        <%= link_to edit_mcalendar_path(ca) do %>
                            <i class="btn btn-primary btn-xs fa fa-wrench"></i>
                          <% end %>
          				        <%= link_to ca, method: :delete, data: { confirm: 'Are you sure?' } do %>
                            <i class="btn btn-danger btn-xs fa fa-trash"></i>
                          <% end %>
              				  <% end %>
              				<% end %>
                    </td>
                    <td>
                    <%= showImage2(:small, ca.user, true) %>
                    </td>
                      <td>
                        <smallcall>
                        <%= ca.user.name + " " + ca.user.lastname %>
                        </smallcal>
                      </td>
                    <td>
                      <smallcall>
                      <%= ca.date_from.strftime("%d.%m.%Y") + "  " + ca.time_from.to_s + "-" + ca.time_to.to_s + " " + (I18n.t :uhr) %><br>
                      </smallcal>
                    </td>
                  </tr>
                <% end %>
              </body>
           	</table>
          </div>
          
        <% when "objekte_cfstatistik" %>
          <div class="panel-body">
            <div id="curve_chart1"></div>
          </div>
          <div class="panel-body">
            <div id="curve_chart2"></div>
          </div>
          
        <% when "objekte_cftransaktionen" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.mstats.order(amount: :desc), "mstats", "owner") %>
          </div>

        <% when "objekte_bewertungen" %>
          <div class="panel-body">
            <%= build_medialistNew(@mobject.mratings.order(created_at: :desc), "mratings", "user") %>
          </div>

        <% when "objekte_standort" %>
          <div class="panel-body">
            <div id="map">
              <div id="map-canvas"></div>
            </div>
          </div>

        <% when "objekte_sensordaten" %>
          <div class="panel-body">
            <div class="row">
              <% if @mobject.mcategory.name == "Wert" %>

                <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3 col-xl-3">
                  <div id="sensorgauge"></div>
                </div>

              <% end %>

              <% if @mobject.mcategory.name == "Schalter" %>
                <% if @mobject.sensors.last %>
                <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3 col-xl-3">
                  <% if @mobject.sensors.last.value > 0 %>
                    <%= image_tag("switch_on.jpg", size: "130x130") %>
                  <% else %>
                    <%= image_tag("switch_off.jpg", size: "130x130") %>
                  <% end %>
                  <br><br>
                </div>
                <% end %>
              <% end %>

              <% if @mobject.mcategory.name == "Farbe" %>
                <% if @mobject.sensors.last %>
                  <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3 col-xl-3">
                    <div class="circle" style="background-color:<%= @mobject.sensors.last.svalue %>"></div>
                  </div>
                <% end %>
              <% end %>

              <div class="col-xs-12 col-sm-9 col-md-9 col-lg-9 col-xl-9">
                <% if @mobject.mcategory.name == "Farbe" %>
                  <% @cols = Sensor.select("svalue").distinct %>
                  <% if @cols %>
                    <% @cols.each do |s| %>
                      <%= link_to mobject_path(:id => @mobject.id, :topic => "objekte_sensordaten", :sensor_color => s.svalue) do %>
                        <div class="circle-min" style="background-color:<%= s.svalue %>"></div>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>

                <div id="sensorchart"></div>

              </div>
            </div>
          </div>

      <% end %>
    </div>
    
  </div>
</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>

$(document).ready(function(){
      google.charts.load('current', {'packages':['corechart']});

      <% if @topic == "objekte_auftragscontrolling" %>

        google.charts.setOnLoadCallback(drawChartallkum);
        function drawChartallkum() {
          var data = google.visualization.arrayToDataTable(<%= raw @istsollkum %>);
          var options = {
            <% if @c_scope == "aufwand" %>
              title: "<%= I18n.t :rapportiertestundenkumuliert %>",
            <% end %>
            <% if @c_scope == "kosten" %>
              title: "<%= I18n.t :rapportiertekostenkumuliert %>",
            <% end %>
            // colors: ['#ACC550','#2E6B33'],
            colors: ['<%= $graph_color1 %>', '<%= $graph_color2 %>'],
            // legend: { position: 'bottom' }
          };

          <% if @c_mode == "Monat" %>
            var chart = new google.visualization.ColumnChart(document.getElementById("auftragschartallkum"));
          <% else %>
            var chart = new google.visualization.LineChart(document.getElementById("auftragschartallkum"));
          <% end %>
          chart.draw(data, options);
        };

        google.charts.setOnLoadCallback(drawChartall);
        function drawChartall() {
          var data = google.visualization.arrayToDataTable(<%= raw @istsoll %>);
          var options = {
            <% if @c_scope == "aufwand" %>
              title: "<%= I18n.t :rapportiertestundenmonat %>",
            <% end %>
            <% if @c_scope == "kosten" %>
              title: "<%= I18n.t :rapportiertekostenmonat %>",
            <% end %>
            colors: ['<%= $graph_color1 %>', '<%= $graph_color2 %>'],
            // colors: ['#ACC550','#2E6B33'],
            // legend: { position: 'bottom' }
          };

          <% if @c_mode == "Monat" %>
            var chart = new google.visualization.ColumnChart(document.getElementById("auftragschartall"));
          <% else %>
            var chart = new google.visualization.LineChart(document.getElementById("auftragschartall"));
          <% end %>
          chart.draw(data, options);
        };

        google.charts.setOnLoadCallback(drawChartuser);
        function drawChartuser() {
          var data = google.visualization.arrayToDataTable(<%= raw @istsollau %>);
          var options = {
            <% if @c_scope == "aufwand" %>
              title: "<%= I18n.t :rapportiertestundenuser %>",
            <% end %>
            <% if @c_scope == "kosten" %>
              title: "<%= I18n.t :rapportiertekostenuser %>",
            <% end %>
            colors: ['<%= $graph_color1 %>', '<% $graph_color2 %>'],
            // colors: ['#ACC550','#2E6B33'],
            // legend: { position: 'bottom' }
          };
          var chart = new google.visualization.ColumnChart(document.getElementById('chartalluser'));
          chart.draw(data, options);
        };

       <% for i in 0..@isoall.length-1 do %>
            google.charts.setOnLoadCallback(drawChart<%= i.to_s %>);
            function drawChart<%= i.to_s %>() {
              var data = google.visualization.arrayToDataTable(<%= raw @isoall[i] %>);
              var options = {
                <% if @c_scope == "aufwand" %>
                  title: "<%= I18n.t :rapportiertestundenuser %>",
                <% end %>
                <% if @c_scope == "kosten" %>
                  title: "<%= I18n.t :rapportiertekostenuser %>",
                <% end %>
                colors: ['<%= $graph_color1 %>', '<%= $graph_color2 %>'],
                // colors: ['#ACC550','#2E6B33'],
                // legend: { position: 'bottom' }
              };
              <% if @c_mode == "Monat" %>
                var chart = new google.visualization.ColumnChart(document.getElementById('<%="chart"+i.to_s %>'));
              <% else %>
                var chart = new google.visualization.LineChart(document.getElementById('<%="chart"+i.to_s %>'));
              <% end %>
              chart.draw(data, options);
            };
            <% i = i + 1 %>
        <% end %>
      
      <% end %>

      <% if @mobject.mtype == "umfragen" and @topic == "objekte_info" %>
      
        <% if false %>
        window.datasetq = [['kategorie', 'anzahl'],['keine Antwort',0]];
        <% @mobject.questions.each do |q| %>
          <% anzCount =0 %>
          <% q.answers.each do |a| %>
            <% anzCount = anzCount + a.user_answers.count %>
          <% end %>
          datasetq.push(['<%= q.name %>', <%= anzCount %>]);
        <% end %>
        google.charts.setOnLoadCallback(drawChartq);

        function drawChartq() {
          var data = google.visualization.arrayToDataTable(datasetq);
          var options = {
            title: "<%= I18n.t :antworten %>",
            colors: ['#ACC550'],
            legend: { position: 'bottom' }
          };
          var chart = new google.visualization.ColumnChart(document.getElementById('chartq'));
          chart.draw(data, options);
        };
        <% end %>
        
        <% @mobject.questions.each do |q| %>
          <% if q.mcategory.name.downcase == "multiple" or q.mcategory.name.downcase == "single" %>
            window.dataset<%= q.id.to_s %> = [['kategorie', 'anzahl'],['keine Antwort',0]];
            <% q.answers.each do |qa| %>
              dataset<%= q.id.to_s %>.push(['<%= qa.name %>', <%= qa.user_answers.where('checker=?',true).count %>]);
            <% end %>
          <% end %>
          <% if q.mcategory.name.downcase == "numerisch" %>
            window.dataset<%= q.id.to_s %> = [['kategorie', 'anzahl'],['keine Antwort',0]];
            <% q.answers.each do |qa| %>
              dataset<%= q.id.to_s %>.push(['Minimum', <%= qa.user_answers.minimum(:num) %>]);
              dataset<%= q.id.to_s %>.push(['Maximum', <%= qa.user_answers.maximum(:num) %>]);
              dataset<%= q.id.to_s %>.push(['Durchschnitt', <%= qa.user_answers.average(:num) %>]);
            <% end %>
          <% end %>
          <% if q.mcategory.name.downcase == "text" %>
            window.dataset<%= q.id.to_s %> = [['kategorie', 'anzahl'],['keine Antwort',0]];
            <% q.answers.each do |qa| %>
              dataset<%= q.id.to_s %>.push(['kein Text angegeben', <%= qa.user_answers.where('description=?',"").count %>]);
              dataset<%= q.id.to_s %>.push(['Text angegeben', <%= qa.user_answers.where('description<>?',"").count %>]);
            <% end %>
          <% end %>
          google.charts.setOnLoadCallback(drawChart<%= q.id.to_s %>);

          function drawChart<%= q.id.to_s %>() {
            var data = google.visualization.arrayToDataTable(dataset<%= q.id.to_s %>);
            var options = {
              title: "<%= I18n.t :antworten %>",
              colors: ['<%= $graph_color1 %>'],
              legend: { position: 'bottom' }
            };
            var chart = new google.visualization.ColumnChart(document.getElementById('<%="chart"+q.id.to_s %>'));
            chart.draw(data, options);
          };
        <% end %>
      <% end %>

      <% if @topic == "objekte_projektdashboard" %>
      
        google.charts.load('current', {'packages':['corechart']});
        <% @projects.each do |p| %>
        
          window.costdataset_<%= p.id %> = [["Zeit", "Wert"],[Date(),0]];
          google.charts.setOnLoadCallback(costfunc<%= p.id %>);
          function costfunc<%= p.id %>() {
            var data = google.visualization.arrayToDataTable(costdataset_<%= p.id %>);
            var options = {
              title: "<%= I18n.t :kosten %>",
              colors: ['#ACC550'],
              curveType: 'function',
              width:150,
              height:150,
              legend: { position: 'bottom' }
            };
            var chart = new google.visualization.LineChart(document.getElementById('costchart<%= p.id %>'));
            chart.draw(data, options);
          }
          
          window.effortdataset_<%= p.id %> = [["Zeit", "Wert"],[Date(),0]];
          google.charts.setOnLoadCallback(effortfunc<%= p.id %>);
          function effortfunc<%= p.id %>() {
            var data = google.visualization.arrayToDataTable(effortdataset_<%= p.id %>);
            var options = {
              title: "<%= I18n.t :aufwand %>",
              colors: ['#ACC550'],
              curveType: 'function',
              width:150,
              height:150,
              legend: { position: 'bottom' }
            };
            var chart = new google.visualization.LineChart(document.getElementById('effortchart<%= p.id %>'));
            chart.draw(data, options);
          }
        <% end %>

        window.setInterval(callme, 15000 );

        function callme() {
          $.ajax({
  
              // url: "http://tkbinfo-horstwurm.c9users.io/home/dashboard_projectdata.json?pid=<%= @mobject.id %>",
              url: "https://mytgcloud.herokuapp.com/home/dashboard_projectdata.json?pid=<%= @mobject.id %>",

              //force to handle it as text
              dataType: "text",
              success: function(data) {
  
                  //data downloaded so we call parseJSON function 
                  //and pass downloaded data
                  var json = $.parseJSON(data);
  
                  //alert(json[0].id + json[0].kategorie + " " + json[0].summe);

                  <% @projects.each do |p| %>
                    for (var i=0;i<json.length;++i)
                    {
                      if (json[i].id == <%= p.id %>) {
                        if (json[i].kategorie == "kosten") {
                          $("#cost<%= p.id  %>").text(json[i].summe + " CHF");
                          costdataset_<%= p.id %>.push([Date(), json[i].summe]);
                          google.charts.setOnLoadCallback(costfunc<%= p.id %>);
                        }
                        if (json[i].kategorie == "aufwand") {
                          $("#effort<%= p.id  %>").text( parseInt( (json[i].summe)/8) + " PT");
                          effortdataset_<%= p.id %>.push([Date(), json[i].summe]);
                          google.charts.setOnLoadCallback(effortfunc<%= p.id %>);
                        }
                      }
                    }
                  <% end %>
                }
            });
        }
      <% end %>

    <% if @topic == "objekte_signstat" %>

        window.datasetsign1 = [['Datum', 'Anzahl']];
        <% @stats.each do |s| %>
          datasetsign1.push(['<%= s.datum %>', <%= s.summe %>]);
        <% end %>
        google.charts.setOnLoadCallback(drawSign1);
        function drawSign1() {
          var data = google.visualization.arrayToDataTable(datasetsign1);
          var options = {
            title: "<%= I18n.t :anzahl %>",
            colors: ['#ACC550'],
            legend: { position: 'bottom' }
          };
          var chart = new google.visualization.LineChart(document.getElementById('signchartzeit'));
          chart.draw(data, options);
        };

        window.datasetsign2 = [['Datum', 'Anzahl']];
        <% @objs.each do |s| %>
          datasetsign2.push(['<%= Mobject.find(s.obj).name %>', <%= s.summe %>]);
        <% end %>
        google.charts.setOnLoadCallback(drawSign2);
        function drawSign2() {
          var data = google.visualization.arrayToDataTable(datasetsign2);
          var options = {
            <% if @mobject.mtype == "kampagnen" %>
              title: "<%= I18n.t :standorte %>",
            <% end %>
            <% if @mobject.mtype == "standorte" %>
              title: "<%= I18n.t :kampagnen %>",
            <% end %>
            colors: ['#ACC550'],
            legend: { position: 'bottom' }
          };
          var chart = new google.visualization.ColumnChart(document.getElementById('signchartobjekt'));
          chart.draw(data, options);
        };
        
        <% if true %>
        <% num = 0 %>
        <% @objs.each do |s| %>
        
            <% num = num + 1 %>

            <% if @mobject.mtype == "kampagnen" %>
              <% @substats = SignageHit.select("date(created_at) as datum, count(mstandort) as summe").where('mkampagne=? and mstandort=?', @mobject.id, s.obj).group("date(created_at)") %>
            <% end %>
            <% if @mobject.mtype == "standorte" %>
              <% @substats = SignageHit.select("date(created_at) as datum, count(mkampagne) as summe").where('mstandort=? and mkampagne=?', @mobject.id, s.obj).group("date(created_at)") %>
            <% end %>

            window.datasetsigno<%= num %> = [['Datum', 'Anzahl']];
            <% @substats.each do |s| %>
              datasetsigno<%= num %>.push(['<%= s.datum %>', <%= s.summe %>]);
            <% end %>
            google.charts.setOnLoadCallback(drawSigno<%= num %>);
            function drawSigno<%= num %>() {
              var data = google.visualization.arrayToDataTable(datasetsigno<%= num %>);
              var options = {
                title: "<%= Mobject.find(s.obj).name %>",
                colors: ['#ACC550'],
                legend: { position: 'bottom' }
              };
              var chart = new google.visualization.LineChart(document.getElementById('signchartobj<%= num %>'));
              chart.draw(data, options);
            };

        <% end %>
        <% end %>

    <% end %>

    <% if @topic == "objekte_sensordaten" %>

      <% if @mobject.mcategory.name == "Farbe" %>
        <% dataset = [["Farbe","Anzahl"]] %>
        <% colorset = [] %>
        <% @cols.each do |t| %>
          <% @text = t.svalue %>
          <% @anz = @mobject.sensors.where('svalue=?',t.svalue).count %>
          <% if @anz and @anz > 0 %>
            <% dataset << [@text, @anz] %>
            <% colorset << @text %>
          <% end %>
        <% end %>
      <% end %>

      <% if @mobject.mcategory.name == "Schalter" or @mobject.mcategory.name == "Wert" %>
        <% dataset = [["Datum", "Alarm", "Wert"]] %>
        <% @iots = @mobject.sensors %>
        <% @iots.each do |i| %>
          <% if @mobject.mcategory.name == "Wert" %>
            <% dataset << [i.created_at.to_s, @mobject.alert, i.value] %>
          <% else %>
            <% dataset << [i.created_at.to_s, 0, i.value] %>
          <% end %>
        <% end %>
      <% end %>
  
      window.sensordataset = <%= raw dataset %>;
      google.charts.setOnLoadCallback(sensorfunc);
      function sensorfunc() {
        var data = google.visualization.arrayToDataTable(sensordataset);
        var options = {
          title: "Sensordaten <%= @mobject.name + " (ID:" + @mobject.id.to_s + ")" %>",
          <% if @mobject.mcategory.name == "Farbe" %>
            colors: <%= raw colorset %>,
          <% else %>
            colors: ['#ff0000','<%= $graph_color1 %>','#ff0000'],
          <% end %>
          curveType: 'function',
          legend: { position: 'bottom' }
        };
        <% if @mobject.mcategory.name == "Farbe" %>
          var chart = new google.visualization.PieChart(document.getElementById('sensorchart'));
        <% else %>
          var chart = new google.visualization.LineChart(document.getElementById('sensorchart'));
        <% end %>
        chart.draw(data, options);
      }

      <% if @mobject.mcategory.name == "Wert" %>
     google.charts.load('current', {'packages':['gauge']});
     <% m = @mobject %>
      <% if m.sensors.last %>
        <% dat = m.sensors.last.created_at.strftime("%m.%d.%Y-%H:%m") %>
        <% wert = m.sensors.last.value %>
        <% if m.mini %>
          <% min = m.mini %>
        <% else %>
          <% min = 0 %>
        <% end %>
        <% if m.maxi %>
          <% max = m.maxi %>
        <% else %>
          <% max = 100 %>
        <% end %>
        <% if m.alert %>
          <% alert = m.alert %>
        <% else %>
          <% alert = 80 %>
        <% end %>
      <% else %>
        <% dat = "nodata" %>
        <% wert = 0 %>
        <% min = 0 %>
        <% max = 100 %>
        <% alert = 80 %>
      <% end %>

      <% if !m.alertlow %>
        <% redf = alert %>
        <% redt = max %>
        <% diff = alert - min %>
        <% yellowf = (alert - (diff * 0.2).to_i) %>
        <% yellowt = alert %>
        <% greenf = min %>
        <% greent = yellowf %>
      <% else %>
        <% redf = min %>
        <% redt = alert %>
        <% diff = max - alert %>
        <% yellowf = redt %>
        <% yellowt = (alert + (diff * 0.2)).to_i %>
        <% greenf = yellowt %>
        <% greent = max %>
      <% end %>

      lastsensordata = [["Datum", "Wert"],["2H", <%= wert %> ]];
      google.charts.setOnLoadCallback(lastsensorwert);
      function lastsensorwert() {
        var data = google.visualization.arrayToDataTable(lastsensordata);
    var options = {
      min: <%= min %>,
      max: <%= max %>,
     redFrom: <%= redf %>, redTo: <%= redt %>,
     yellowFrom: <%= yellowf %>, yellowTo: <%= yellowt %>,
     greenFrom: <%= greenf %>, greenTo: <%= greent %>,
     minorTicks: 5
    };
        var chart = new google.visualization.Gauge(document.getElementById("sensorgauge"));
        chart.draw(data, options);
      };
      <% end %>

      <% if @mobject.mcategory.name != "Farbe" %>
      window.setInterval(callme, 5000);
      <% end %>

      function callme() {
        
          $.ajax({
  
              url: "/home/readsensordata.json?sensor=<%= @mobject.id %>",
              // url: "https://tgcloud-horstwurm.c9users.io/home/readsensordata.json?sensor=<%= @mobject.id %>",
              dataType: "text",
              success: function(data) {
    
                  //data downloaded so we call parseJSON function 
                  //and pass downloaded data
                  var json = $.parseJSON(data);
      
                  //alert(json[0].datum + " " + json[0].wert);
    
                  //alert("test");
                  sensordataset = [["Datum", "Alarm", "Wert"]];
                  // sensordataset.push(["today", 100]);
                  lastwert = 0;
                  lastdatum = "kein Datum"
                  for (var i=0;i<json.length;++i)
                  {
                    sensordataset.push([json[i].datum, <%= @mobject.alert %>, json[i].wert]);
                    lastwert = json[i].wert;
                    lastdatum = json[i].datum;
                    //alert(json[i].wert);
                  }
                  google.charts.setOnLoadCallback(sensorfunc);

                  //lastwert = Math.floor((Math.random() * 100) + 1); 
                  lastsensordata = [["Datum", "Wert"],[lastdatum, lastwert]];
                  google.charts.setOnLoadCallback(lastsensorwert);

                }
            });
            
      }
    <% end %>

    <% if @topic == "objekte_kalendervermietungen" %>
        $('#calendar').fullCalendar({
            now: '<%= DateTime.now %>',
            allDaySlot: false,
            timeFormat: 'H(:mm)',
            defaultView: 'basicWeek',
            defaultView: 'basicDay',
            defaultView: 'basicWeek',
            defaultView: 'listYear',
            defaultView: 'month',
            defaultView: 'agendaWeek',
            slotDuration: '1:00:00',
            contentHeight: 'auto',
            <% if @mobject.time_from and @mobject.time_to %>
              minTime: '<%= @mobject.time_from %>:00',
              maxTime: '<%= @mobject.time_to %>:00',
            <% end %>
            textColor: 'white',
            firstDay: 1,
            weekNumbers: true,
            events: [<%= raw @array %> ]
        });
    <% end %>

    $("a").tooltip();
    
    $('.owl-show').owlCarousel({  
      itemsCustom : false,
      itemsDesktop : [1199,4],
      itemsDesktopSmall : [980,3],
      itemsTablet: [768,2],
      itemsTabletSmall: false,
      itemsMobile : [479,1],
      autoPlay: true
    });

  <% if @topic == "objekte_info" and @mobject.latitude and @mobject.longitude %>
    function init_map(index) {
        var latitudes = [<%= @mobject.latitude %>];
        var longitudes = [<%= @mobject.longitude %>];
        var myLocation = new google.maps.LatLng(latitudes[index], longitudes[index]);
        var mapOptions = {
            center: myLocation,
            zoom: 16
        };
        var marker = new google.maps.Marker({
            position: myLocation,
            title: "Property Location"
        });
        var map = new google.maps.Map(document.getElementById("map"),mapOptions);
        marker.setMap(map);
    }
  <% end %>

  <% if @topic == "objekte_cfstatistik" %>
      google.charts.setOnLoadCallback(drawChartA);
      function drawChartA() {
        var data = google.visualization.arrayToDataTable(<%= raw @anz_s %>);
        var options = {
          title: "<% I18n.t :cfanzahl %>",
          curveType: 'function',
          colors: ['#ACC550'],
          legend: { position: 'bottom' }
        };
        var chart = new google.visualization.LineChart(document.getElementById('curve_chart1'));
        chart.draw(data, options);
      }
  
      google.charts.setOnLoadCallback(drawChartB);
      function drawChartB() {
        var data = google.visualization.arrayToDataTable(<%= raw @bet_s %>);
        var options = {
          title: "<% I18n.t :cfbetrag %>",
          curveType: 'function',
          colors: ['#ACC550'],
          legend: { position: 'bottom' }
        };
        var chart = new google.visualization.LineChart(document.getElementById('curve_chart2'));
        chart.draw(data, options);
      }
      
  <% end %>

});
</script>

<script>
<% case @topic %>
  <% when "objekte_info" %>
      document.addEventListener("turbolinks:load", function() {init_map(0);})

  <% when "objekte_auftragscontrolling" %>
      document.addEventListener("turbolinks:load", function() {drawChartallkum(); drawChartall(); drawChartuser();})

  <% when "objekte_projektdashboard" %>
      document.addEventListener("turbolinks:load", function() {callme();})

  <% when "objekte_signstat" %>
      document.addEventListener("turbolinks:load", function() {drawSign1();drawSign2();})

  <% when "objekte_umfragen" %>
      document.addEventListener("turbolinks:load", function() {})

<% end %>


</script>

<script>$('.dropdown-toggle').dropdown()</script>